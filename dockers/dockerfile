# 使用官方 Debian Bookworm 作为基础镜像
FROM debian:bookworm

# 设置非交互式环境变量，避免安装时卡住
ENV DEBIAN_FRONTEND=noninteractive

# 更新包列表并安装所需系统依赖
# 合并所有 apt 操作到一个 RUN 层以减小镜像体积
RUN apt update && \
    apt install -y --no-install-recommends \
        cmake \
        make \
        gcc \
        g++ \
        unzip \
        wget \
        npm \
        libnl-genl-3-dev \
        libnl-3-dev \
        libi2c-dev \
        libxml2-dev \
        libgpiod-dev \
        liburing-dev \
        libcereal-dev \
        libldap2-dev \
        libsasl2-dev \
        zlib1g-dev \
        libssl-dev \
        libpam0g-dev \
        libnl-genl-3-dev \
        libnl-3-dev \
        git \
        libnghttp2-dev \
        libzstd-dev \
        libtinyxml2-dev \
        systemd \
        libsystemd-dev \
        libfmt-dev \
        libdbus-1-dev \
        supervisor \
        vim \
        iproute2 \
        build-essential \
        devscripts \
        debhelper \
        dh-make \
        lintian \
        python3 \
        python3-dbus \
        python3-pip \
        python3-yaml && \
    # 清理缓存以减小镜像大小
    apt clean && \
    rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/Naios/function2.git && cp -r function2/include/function2 /usr/local/include/ && rm -rf function2

COPY ["pwhistory.conf", "/etc/security"]
COPY ["pwquality.conf", "/etc/security"]

RUN groupadd redfish && \
    groupadd ipmi && \
    groupadd hostconsole && \
    groupadd priv-admin && \
    groupadd priv-operator && \
    groupadd priv-user

RUN echo 'root:123' | chpasswd

RUN usermod -aG redfish,priv-admin root


# 使用 pip 安装 Python 构建工具
# 注意：--break-system-packages 在容器中通常不需要，但保留以匹配你的需求
RUN pip3 install --break-system-packages meson ninja inflection mako jsonschema

COPY ["format", "/usr/local/include/"]

COPY supervisor/* /etc/supervisor/conf.d/

# 设置工作目录
WORKDIR /app

# 可选：声明容器启动时的默认命令（可根据实际用途修改）
CMD ["supervisord", "-c", "/etc/supervisor/supervisord.conf"]
